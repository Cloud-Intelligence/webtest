<!DOCTYPE html><html class=no-js data-astro-cid-scuu7fyy lang=en><head><script>!function(e){e.className=e.className.replace(/\bno-js\b/,"js")}(document.documentElement)</script><meta charset=UTF-8><meta content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no,shrink-to-fit=no" name=viewport><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="telephone=no" name=format-detection><meta content=#3366FF name=theme-color><title>Building a Secure, Production-Ready Chat API: Architecture, Security, and Performance - Cloud Intelligence</title><meta content="Building a Secure, Production-Ready Chat API: Architecture, Security, and Performance - Cloud Intelligence" name=title><meta content="Cloud Intelligence - Building intelligent cloud solutions" name=description><meta content="cloud computing, software development, AI, machine learning, data engineering" name=keywords><link href=https://cloudintellligence.africa/blog/building-secure-chat-api/ rel=canonical><meta content=article property=og:type><meta content=https://cloudintellligence.africa/blog/building-secure-chat-api/ property=og:url><meta content="Building a Secure, Production-Ready Chat API: Architecture, Security, and Performance - Cloud Intelligence" property=og:title><meta content="Cloud Intelligence - Building intelligent cloud solutions" property=og:description><meta content=https://cloudintellligence.africa/logo.png property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://cloudintellligence.africa/blog/building-secure-chat-api/ property=twitter:url><meta content="Building a Secure, Production-Ready Chat API: Architecture, Security, and Performance - Cloud Intelligence" property=twitter:title><meta content="Cloud Intelligence - Building intelligent cloud solutions" property=twitter:description><meta content=https://cloudintellligence.africa/logo.png property=twitter:image><link href=/webtest/favicon.webp rel=icon type=image/webp><link href=/webtest/ci-fav-icon.svg rel=icon type=image/svg+xml><link href=/webtest/logo.png rel=icon type=image/png><link href=/webtest/favicon.webp rel=apple-touch-icon><link href=/webtest/favicon.webp rel="shortcut icon"><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link href=https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://fonts.gstatic.com/s/manrope/v15/xn7_YHE41ni1AdIRqAuZuw1Bx9mbZk59FO_F87jxeN7B.woff2 rel=preload type=font/woff2 as=font crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Manrope:wght@500;700&family=Press+Start+2P&display=swap" rel=preload as=style onload="this.onload=null,this.rel=&#34;stylesheet&#34;"><noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Manrope:wght@500;700&family=Press+Start+2P&display=swap" rel=stylesheet></noscript><link href=//fonts.googleapis.com rel=dns-prefetch><link href=//fonts.gstatic.com rel=dns-prefetch><link href=/assets/_slug_.C2v1qqan.css rel=stylesheet><link href=/assets/_slug_.B-isVlt3.css rel=stylesheet><style>[data-astro-cid-scuu7fyy],[data-astro-cid-scuu7fyy]:after,[data-astro-cid-scuu7fyy]:before{box-sizing:border-box}html{-webkit-text-size-adjust:100%;line-height:1.15}body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-display:swap;margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif}.skip-link[data-astro-cid-scuu7fyy]{color:#fff;z-index:2000;background:#000;border-radius:0 0 4px 4px;padding:8px;font-size:14px;font-weight:600;text-decoration:none;transition:top .3s;position:absolute;top:-40px;left:6px}.skip-link[data-astro-cid-scuu7fyy]:focus{top:0}</style></head><body data-astro-cid-scuu7fyy><a class=skip-link href=#main data-astro-cid-scuu7fyy>Skip to main content</a><main data-astro-cid-scuu7fyy id=main><main class="bg-white min-h-screen" data-astro-cid-7jjqptxk><article class="max-w-4xl mx-auto px-6 py-12" data-astro-cid-7jjqptxk><nav class=mb-12 data-astro-cid-7jjqptxk><a class="font-sans font-medium text-sm transition-colors hover:text-gray-900 inline-flex items-center text-gray-600" href=/webtest/resources/technical-blog data-astro-cid-7jjqptxk><svg class="h-4 mr-2 w-4" data-astro-cid-7jjqptxk fill=none stroke=currentColor viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" data-astro-cid-7jjqptxk stroke-linecap=round stroke-linejoin=round stroke-width=2></path></svg> Technical Blog</a></nav><header class="mb-12 max-w-3xl" data-astro-cid-7jjqptxk><h1 class="font-sans text-gray-900 font-bold leading-tight mb-6 md:text-5xl text-4xl tracking-tight" data-astro-cid-7jjqptxk>Building a Secure, Production-Ready Chat API: Architecture, Security, and Performance</h1><p class="font-sans leading-relaxed mb-8 text-gray-600 text-xl" data-astro-cid-7jjqptxk>A comprehensive deep dive into building an enterprise-grade chat API with FastAPI, featuring JWT authentication, rate limiting, input sanitization, and real-time Discord notifications.</p><div data-astro-cid-7jjqptxk class="flex items-center justify-between border-gray-200 border-y py-6"><div data-astro-cid-7jjqptxk class="flex items-center gap-4"><div data-astro-cid-7jjqptxk class="font-sans text-sm items-center bg-gradient-to-br flex font-bold from-blue-500 h-12 justify-center rounded-full text-white to-purple-600 w-12">CI</div><div data-astro-cid-7jjqptxk><div data-astro-cid-7jjqptxk class="font-sans font-medium text-gray-900">Cloud Intelligence Team</div><div data-astro-cid-7jjqptxk class="font-sans text-sm text-gray-600"><time data-astro-cid-7jjqptxk datetime=2024-12-16T00:00:00.000Z>December 16, 2024 </time><span class=mx-2 data-astro-cid-7jjqptxk>·</span> <span data-astro-cid-7jjqptxk>5 min read</span></div></div></div><div data-astro-cid-7jjqptxk class="flex gap-2 flex-wrap"><span class="font-sans font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full text-xs" data-astro-cid-7jjqptxk>fastapi </span><span class="font-sans font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full text-xs" data-astro-cid-7jjqptxk>security </span><span class="font-sans font-medium text-gray-700 bg-gray-100 px-3 py-1 rounded-full text-xs" data-astro-cid-7jjqptxk>api</span></div></div></header><div data-astro-cid-7jjqptxk class=blog-content><h1 id=building-a-secure-production-ready-chat-api-architecture-security-and-performance>Building a Secure, Production-Ready Chat API: Architecture, Security, and Performance</h1><p><em>How we engineered a robust chat API that handles authentication, message persistence, AI integration, and real-time notifications while maintaining enterprise-grade security</em></p><h2 id=introduction>Introduction</h2><p>Building a chat API might seem straightforward on the surface, but creating one that’s truly production-ready involves solving complex challenges around security, scalability, and reliability. Our journey building the Cloud Intelligence chat API taught us that every architectural decision—from authentication patterns to message storage—has cascading effects on performance, security, and user experience.</p><p>This blog post chronicles the complete architecture of our chat API, from the initial security requirements to the final deployment. We’ll explore the technical decisions, security implementations, and performance optimizations that enable our API to handle enterprise workloads while maintaining sub-200ms response times.</p><h2 id=the-challenge-beyond-basic-crud>The Challenge: Beyond Basic CRUD</h2><p>Traditional chat APIs often focus solely on message exchange, but enterprise requirements demand much more:</p><ul><li><strong>Authentication &#x26; Authorization</strong>: Session-based JWT with rate limiting</li><li><strong>Input Sanitization</strong>: Protection against XSS, injection, and reflection attacks</li><li><strong>Message Persistence</strong>: Reliable storage with conversation history</li><li><strong>Real-time Notifications</strong>: Discord integration for monitoring</li><li><strong>AI Integration</strong>: Seamless LLM integration with context awareness</li><li><strong>Performance</strong>: Sub-200ms response times under load</li></ul><h2 id=architecture-overview-the-foundation>Architecture Overview: The Foundation</h2><h3 id=core-technology-stack>Core Technology Stack</h3><p>We built our API using <strong>FastAPI</strong> with a carefully curated technology stack:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># requirements.txt - Our production dependencies</span></span>
<span class=line><span style=color:#e1e4e8>fastapi</span><span style=color:#f97583>==</span><span style=color:#79b8ff>0.115</span><span style=color:#e1e4e8>.4           </span><span style=color:#6a737d># High-performance async API framework</span></span>
<span class=line><span style=color:#e1e4e8>uvicorn[standard]</span><span style=color:#f97583>==</span><span style=color:#79b8ff>0.32</span><span style=color:#e1e4e8>.0  </span><span style=color:#6a737d># ASGI server with auto-reload</span></span>
<span class=line><span style=color:#e1e4e8>sqlalchemy</span><span style=color:#f97583>==</span><span style=color:#79b8ff>2.0</span><span style=color:#e1e4e8>.36         </span><span style=color:#6a737d># Modern ORM with async support</span></span>
<span class=line><span style=color:#e1e4e8>alembic</span><span style=color:#f97583>==</span><span style=color:#79b8ff>1.14</span><span style=color:#e1e4e8>.0           </span><span style=color:#6a737d># Database migration management</span></span>
<span class=line><span style=color:#e1e4e8>pydantic</span><span style=color:#f97583>==</span><span style=color:#79b8ff>2.10</span><span style=color:#e1e4e8>.1          </span><span style=color:#6a737d># Data validation and serialization</span></span>
<span class=line><span style=color:#e1e4e8>python</span><span style=color:#f97583>-</span><span style=color:#e1e4e8>jose[cryptography]  </span><span style=color:#6a737d># JWT token handling</span></span>
<span class=line><span style=color:#e1e4e8>bcrypt</span><span style=color:#f97583>==</span><span style=color:#79b8ff>4.2</span><span style=color:#e1e4e8>.1             </span><span style=color:#6a737d># Password hashing</span></span>
<span class=line><span style=color:#e1e4e8>slowapi</span><span style=color:#f97583>==</span><span style=color:#79b8ff>0.1</span><span style=color:#e1e4e8>.9            </span><span style=color:#6a737d># Rate limiting for FastAPI</span></span>
<span class=line><span style=color:#e1e4e8>nh3</span><span style=color:#f97583>==</span><span style=color:#79b8ff>0.2</span><span style=color:#e1e4e8>.20               </span><span style=color:#6a737d># Fast HTML sanitization</span></span>
<span class=line><span style=color:#e1e4e8>litellm</span><span style=color:#f97583>==</span><span style=color:#79b8ff>1.55</span><span style=color:#e1e4e8>.7           </span><span style=color:#6a737d># Multi-provider LLM integration</span></span>
<span class=line><span style=color:#e1e4e8>discord.py</span><span style=color:#f97583>==</span><span style=color:#79b8ff>2.4</span><span style=color:#e1e4e8>.0         </span><span style=color:#6a737d># Discord bot integration</span></span>
<span class=line><span style=color:#e1e4e8>loguru</span><span style=color:#f97583>==</span><span style=color:#79b8ff>0.7</span><span style=color:#e1e4e8>.3             </span><span style=color:#6a737d># Structured logging</span></span></code></pre><h3 id=modular-architecture-pattern>Modular Architecture Pattern</h3><p>Our API follows a strict modular architecture for maintainability and testing:</p><pre class="astro-code github-dark" data-language=plaintext style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span>api/</span></span>
<span class=line><span>├── app/</span></span>
<span class=line><span>│   ├── main.py              # Application entry point</span></span>
<span class=line><span>│   ├── core/</span></span>
<span class=line><span>│   │   └── config.py        # Environment-aware configuration</span></span>
<span class=line><span>│   ├── routers/</span></span>
<span class=line><span>│   │   ├── auth.py          # Authentication endpoints</span></span>
<span class=line><span>│   │   ├── chat.py          # Chat message handling</span></span>
<span class=line><span>│   │   └── system.py        # Health checks and monitoring</span></span>
<span class=line><span>│   ├── models/</span></span>
<span class=line><span>│   │   ├── auth.py          # Pydantic request/response models</span></span>
<span class=line><span>│   │   └── chat.py          # Chat message models</span></span>
<span class=line><span>│   ├── database/</span></span>
<span class=line><span>│   │   ├── models.py        # SQLAlchemy database models</span></span>
<span class=line><span>│   │   └── connection.py    # Database session management</span></span>
<span class=line><span>│   ├── middleware/</span></span>
<span class=line><span>│   │   ├── security.py      # CORS and security headers</span></span>
<span class=line><span>│   │   └── error_handler.py # Global exception handling</span></span>
<span class=line><span>│   └── dependencies/</span></span>
<span class=line><span>│       ├── auth.py          # JWT authentication dependency</span></span>
<span class=line><span>│       └── database.py      # Database session dependency</span></span>
<span class=line><span>├── tests/                   # Comprehensive test suite</span></span>
<span class=line><span>└── alembic/                # Database migrations</span></span></code></pre><h2 id=security-architecture-defense-in-depth>Security Architecture: Defense in Depth</h2><h3 id=jwt-authentication-with-session-management>JWT Authentication with Session Management</h3><p>Our authentication system combines the stateless benefits of JWT with session-based security:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># app/dependencies/auth.py</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> typing </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> Dict</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> fastapi </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> Depends, HTTPException, status</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> fastapi.security </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> HTTPBearer, HTTPAuthorizationCredentials</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> jose </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> JWTError, jwt</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> app.core.config </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> get_settings</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>security </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> HTTPBearer()</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>async</span><span style=color:#f97583> def</span><span style=color:#b392f0> get_current_user</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>    credentials: HTTPAuthorizationCredentials </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Depends(security)</span></span>
<span class=line><span style=color:#e1e4e8>) -> Dict:</span></span>
<span class=line><span style=color:#9ecbff>    """</span></span>
<span class=line><span style=color:#9ecbff>    Validate JWT token and return user claims</span></span>
<span class=line><span style=color:#9ecbff>    Uses session ID (jti) for additional security</span></span>
<span class=line><span style=color:#9ecbff>    """</span></span>
<span class=line><span style=color:#e1e4e8>    settings </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> get_settings()</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>        # Decode and validate JWT</span></span>
<span class=line><span style=color:#e1e4e8>        payload </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> jwt.decode(</span></span>
<span class=line><span style=color:#e1e4e8>            credentials.credentials,</span></span>
<span class=line><span style=color:#e1e4e8>            settings.</span><span style=color:#79b8ff>JWT_SECRET_KEY</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>            algorithms</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>[settings.</span><span style=color:#79b8ff>JWT_ALGORITHM</span><span style=color:#e1e4e8>]</span></span>
<span class=line><span style=color:#e1e4e8>        )</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Extract session ID from JWT ID claim</span></span>
<span class=line><span style=color:#e1e4e8>        session_id: </span><span style=color:#79b8ff>str</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> payload.get(</span><span style=color:#9ecbff>"jti"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> session_id </span><span style=color:#f97583>is</span><span style=color:#79b8ff> None</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#f97583>            raise</span><span style=color:#e1e4e8> HTTPException(</span></span>
<span class=line><span style=color:#ffab70>                status_code</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>status.</span><span style=color:#79b8ff>HTTP_401_UNAUTHORIZED</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                detail</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Invalid authentication credentials"</span></span>
<span class=line><span style=color:#e1e4e8>            )</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#e1e4e8> payload</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#f97583>    except</span><span style=color:#e1e4e8> JWTError:</span></span>
<span class=line><span style=color:#f97583>        raise</span><span style=color:#e1e4e8> HTTPException(</span></span>
<span class=line><span style=color:#ffab70>            status_code</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>status.</span><span style=color:#79b8ff>HTTP_401_UNAUTHORIZED</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>            detail</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Could not validate credentials"</span></span>
<span class=line><span style=color:#e1e4e8>        )</span></span></code></pre><h3 id=advanced-input-sanitization>Advanced Input Sanitization</h3><p>We implemented a multi-layer sanitization system to prevent various attack vectors:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># app/routers/chat.py - Input sanitization implementation</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> nh3</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> re</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> typing </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> List</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>def</span><span style=color:#b392f0> sanitize_and_validate_input</span><span style=color:#e1e4e8>(user_input: </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>) -> tuple[</span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>bool</span><span style=color:#e1e4e8>]:</span></span>
<span class=line><span style=color:#9ecbff>    """</span></span>
<span class=line><span style=color:#9ecbff>    Sanitize user input and detect dangerous patterns</span></span>
<span class=line><span style=color:#9ecbff>    Returns: (sanitized_content, contains_dangerous_content)</span></span>
<span class=line><span style=color:#9ecbff>    """</span></span>
<span class=line><span style=color:#6a737d>    # Use nh3 for HTML/XSS sanitization (20x faster than bleach)</span></span>
<span class=line><span style=color:#e1e4e8>    sanitized_message </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> nh3.clean(</span></span>
<span class=line><span style=color:#e1e4e8>        user_input,</span></span>
<span class=line><span style=color:#ffab70>        tags</span><span style=color:#f97583>=</span><span style=color:#79b8ff>set</span><span style=color:#e1e4e8>(),  </span><span style=color:#6a737d># Remove all HTML tags</span></span>
<span class=line><span style=color:#ffab70>        attributes</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{},  </span><span style=color:#6a737d># Remove all attributes</span></span>
<span class=line><span style=color:#ffab70>        strip_comments</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>        link_rel</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"nofollow noopener noreferrer"</span></span>
<span class=line><span style=color:#e1e4e8>    )</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Define comprehensive dangerous pattern detection</span></span>
<span class=line><span style=color:#e1e4e8>    dangerous_patterns </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#6a737d>        # XSS and JavaScript injection</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>'</span><span style=color:#dbedff>javascript:</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#dbedff>data:</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#dbedff>vbscript:</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>'</span><span style=color:#dbedff>&#x3C;script</span><span style=color:#79b8ff>[</span><span style=color:#f97583>^</span><span style=color:#79b8ff>>]</span><span style=color:#f97583>*</span><span style=color:#dbedff>></span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#dbedff>onerror</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>=</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#dbedff>onload</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>=</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # SQL injection patterns</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>;</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>DROP</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>+</span><span style=color:#dbedff>TABLE</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>'</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>OR</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>'</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>UNION</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>+</span><span style=color:#dbedff>SELECT</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Command injection</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>;</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>cat</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>+</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\|</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>whoami</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>&#x26;&#x26;</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>*</span><span style=color:#dbedff>rm</span><span style=color:#79b8ff>\s</span><span style=color:#f97583>+</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Path traversal (including encoded variants)</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\.\.</span><span style=color:#dbedff>/</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\.\.\\</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>%2e%2e%2f</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>%252e%252e%252f</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Template injection</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\{\{</span><span style=color:#79b8ff>[</span><span style=color:#f97583>^</span><span style=color:#79b8ff>}]</span><span style=color:#f97583>*</span><span style=color:#85e89d;font-weight:700>\}\}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\$\{</span><span style=color:#79b8ff>[</span><span style=color:#f97583>^</span><span style=color:#79b8ff>}]</span><span style=color:#f97583>*</span><span style=color:#85e89d;font-weight:700>\}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#dbedff>&#x3C;%=</span><span style=color:#79b8ff>.</span><span style=color:#f97583>*</span><span style=color:#dbedff>%></span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # NoSQL injection</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>'</span><span style=color:#85e89d;font-weight:700>\$</span><span style=color:#dbedff>gt</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#85e89d;font-weight:700>\$</span><span style=color:#dbedff>ne</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#85e89d;font-weight:700>\$</span><span style=color:#dbedff>where</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>'</span><span style=color:#85e89d;font-weight:700>\$</span><span style=color:#dbedff>regex</span><span style=color:#9ecbff>'</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # LDAP injection</span></span>
<span class=line><span style=color:#f97583>        r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\*\)\(</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\)\(</span><span style=color:#dbedff>&#x26;</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>r</span><span style=color:#9ecbff>"</span><span style=color:#85e89d;font-weight:700>\)\(</span><span style=color:#dbedff>cn=</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    ]</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Check for dangerous content</span></span>
<span class=line><span style=color:#e1e4e8>    contains_dangerous_content </span><span style=color:#f97583>=</span><span style=color:#79b8ff> any</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>        re.search(pattern, user_input.lower(), re.</span><span style=color:#79b8ff>IGNORECASE</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> pattern </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> dangerous_patterns</span></span>
<span class=line><span style=color:#e1e4e8>    )</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8> sanitized_message, contains_dangerous_content</span></span></code></pre><h3 id=rate-limiting-and-bot-detection>Rate Limiting and Bot Detection</h3><p>We implemented sophisticated rate limiting with bot detection:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># app/dependencies/auth.py - Rate limiting implementation</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> slowapi </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> Limiter, _rate_limit_exceeded_handler</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> slowapi.util </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> get_remote_address</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> slowapi.errors </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> RateLimitExceeded</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>limiter </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Limiter(</span><span style=color:#ffab70>key_func</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>get_remote_address)</span></span>
<span class=line></span>
<span class=line><span style=color:#b392f0>@router.post</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>"/chat"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#b392f0>@limiter.limit</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>"10/minute"</span><span style=color:#e1e4e8>)  </span><span style=color:#6a737d># 10 requests per minute per IP</span></span>
<span class=line><span style=color:#f97583>async</span><span style=color:#f97583> def</span><span style=color:#b392f0> chat_endpoint</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>    request: Request,</span></span>
<span class=line><span style=color:#e1e4e8>    chat_request: ChatRequest,</span></span>
<span class=line><span style=color:#e1e4e8>    current_user: Dict </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Depends(get_current_user),</span></span>
<span class=line><span style=color:#e1e4e8>    db: Session </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Depends(get_db),</span></span>
<span class=line><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#9ecbff>    """Chat endpoint with comprehensive rate limiting"""</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Additional bot detection</span></span>
<span class=line><span style=color:#e1e4e8>    user_agent </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> request.headers.get(</span><span style=color:#9ecbff>"user-agent"</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>""</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>    if</span><span style=color:#79b8ff> len</span><span style=color:#e1e4e8>(user_agent) </span><span style=color:#f97583>&#x3C;</span><span style=color:#e1e4e8> settings.</span><span style=color:#79b8ff>MIN_USER_AGENT_LENGTH</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>        logger.warning(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Suspicious user agent from IP: </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>get_remote_address(request)</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>        raise</span><span style=color:#e1e4e8> HTTPException(</span><span style=color:#ffab70>status_code</span><span style=color:#f97583>=</span><span style=color:#79b8ff>403</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>detail</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Invalid request"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Message limit per session (50 messages max)</span></span>
<span class=line><span style=color:#e1e4e8>    session_id </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> current_user.get(</span><span style=color:#9ecbff>"jti"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    message_count </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> db.query(ChatMessage).filter(</span></span>
<span class=line><span style=color:#e1e4e8>        ChatMessage.session_id </span><span style=color:#f97583>==</span><span style=color:#e1e4e8> session_id,</span></span>
<span class=line><span style=color:#e1e4e8>        ChatMessage.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "user"</span></span>
<span class=line><span style=color:#e1e4e8>    ).count()</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    if</span><span style=color:#e1e4e8> message_count </span><span style=color:#f97583>>=</span><span style=color:#79b8ff> 50</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#f97583>        raise</span><span style=color:#e1e4e8> HTTPException(</span></span>
<span class=line><span style=color:#ffab70>            status_code</span><span style=color:#f97583>=</span><span style=color:#79b8ff>429</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>            detail</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Message limit exceeded. Maximum 50 messages per session."</span></span>
<span class=line><span style=color:#e1e4e8>        )</span></span></code></pre><h2 id=database-architecture-performance-and-reliability>Database Architecture: Performance and Reliability</h2><h3 id=sqlalchemy-models-with-optimized-indexing>SQLAlchemy Models with Optimized Indexing</h3><p>Our database schema is designed for both performance and data integrity:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># app/database/models.py</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> sqlalchemy </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> Column, String, DateTime, Text, Boolean, ForeignKey, Index</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> sqlalchemy.ext.declarative </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> declarative_base</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> sqlalchemy.orm </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> relationship</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> secrets</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> datetime </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> datetime</span></span>
<span class=line></span>
<span class=line><span style=color:#e1e4e8>Base </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> declarative_base()</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> Session</span><span style=color:#e1e4e8>(</span><span style=color:#b392f0>Base</span><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#9ecbff>    """User session management with Discord integration"""</span></span>
<span class=line><span style=color:#e1e4e8>    __tablename__ </span><span style=color:#f97583>=</span><span style=color:#9ecbff> "sessions"</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#79b8ff>    id</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>32</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>primary_key</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=lambda</span><span style=color:#e1e4e8>: secrets.token_urlsafe(</span><span style=color:#79b8ff>24</span><span style=color:#e1e4e8>))</span></span>
<span class=line><span style=color:#e1e4e8>    email_hash </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>64</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>index</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    browser_hash </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>64</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    ip_address </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>45</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>)  </span><span style=color:#6a737d># Supports IPv6</span></span>
<span class=line><span style=color:#e1e4e8>    discord_thread_id </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>32</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    created_at </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(DateTime, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>datetime.utcnow)</span></span>
<span class=line><span style=color:#e1e4e8>    expires_at </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(DateTime, </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    last_activity </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(DateTime, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>datetime.utcnow)</span></span>
<span class=line><span style=color:#e1e4e8>    is_active </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(Boolean, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>index</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Relationships</span></span>
<span class=line><span style=color:#e1e4e8>    messages </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> relationship(</span><span style=color:#9ecbff>"ChatMessage"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>back_populates</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"session"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Performance indexes</span></span>
<span class=line><span style=color:#e1e4e8>    __table_args__ </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> (</span></span>
<span class=line><span style=color:#e1e4e8>        Index(</span><span style=color:#9ecbff>'idx_session_active_expiry'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'is_active'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'expires_at'</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        Index(</span><span style=color:#9ecbff>'idx_session_email_active'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'email_hash'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'is_active'</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>    )</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> ChatMessage</span><span style=color:#e1e4e8>(</span><span style=color:#b392f0>Base</span><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#9ecbff>    """Chat messages with conversation threading"""</span></span>
<span class=line><span style=color:#e1e4e8>    __tablename__ </span><span style=color:#f97583>=</span><span style=color:#9ecbff> "chat_messages"</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#79b8ff>    id</span><span style=color:#f97583> =</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>32</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>primary_key</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=lambda</span><span style=color:#e1e4e8>: secrets.token_urlsafe(</span><span style=color:#79b8ff>16</span><span style=color:#e1e4e8>))</span></span>
<span class=line><span style=color:#e1e4e8>    session_id </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>32</span><span style=color:#e1e4e8>), ForeignKey(</span><span style=color:#9ecbff>"sessions.id"</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>index</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    message_type </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(String(</span><span style=color:#79b8ff>20</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>index</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)  </span><span style=color:#6a737d># 'user' or 'assistant'</span></span>
<span class=line><span style=color:#e1e4e8>    content </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(Text, </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    timestamp </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Column(DateTime, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>datetime.utcnow, </span><span style=color:#ffab70>index</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Relationships</span></span>
<span class=line><span style=color:#e1e4e8>    session </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> relationship(</span><span style=color:#9ecbff>"Session"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>back_populates</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"messages"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Performance indexes for chat history queries</span></span>
<span class=line><span style=color:#e1e4e8>    __table_args__ </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> (</span></span>
<span class=line><span style=color:#e1e4e8>        Index(</span><span style=color:#9ecbff>'idx_message_session_type'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'session_id'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'message_type'</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        Index(</span><span style=color:#9ecbff>'idx_message_session_time'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'session_id'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'timestamp'</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>    )</span></span></code></pre><h3 id=database-migration-strategy>Database Migration Strategy</h3><p>We use Alembic for version-controlled database migrations:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># alembic/versions/001_initial_schema.py</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> alembic </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> op</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> sqlalchemy </span><span style=color:#f97583>as</span><span style=color:#e1e4e8> sa</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>def</span><span style=color:#b392f0> upgrade</span><span style=color:#e1e4e8>():</span></span>
<span class=line><span style=color:#9ecbff>    """Create initial database schema"""</span></span>
<span class=line><span style=color:#6a737d>    # Sessions table</span></span>
<span class=line><span style=color:#e1e4e8>    op.create_table(</span></span>
<span class=line><span style=color:#9ecbff>        'sessions'</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'id'</span><span style=color:#e1e4e8>, sa.String(</span><span style=color:#79b8ff>32</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>primary_key</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'email_hash'</span><span style=color:#e1e4e8>, sa.String(</span><span style=color:#79b8ff>64</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'browser_hash'</span><span style=color:#e1e4e8>, sa.String(</span><span style=color:#79b8ff>64</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'ip_address'</span><span style=color:#e1e4e8>, sa.String(</span><span style=color:#79b8ff>45</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'discord_thread_id'</span><span style=color:#e1e4e8>, sa.String(</span><span style=color:#79b8ff>32</span><span style=color:#e1e4e8>), </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'created_at'</span><span style=color:#e1e4e8>, sa.DateTime, </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'expires_at'</span><span style=color:#e1e4e8>, sa.DateTime, </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'last_activity'</span><span style=color:#e1e4e8>, sa.DateTime, </span><span style=color:#ffab70>nullable</span><span style=color:#f97583>=</span><span style=color:#79b8ff>False</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>        sa.Column(</span><span style=color:#9ecbff>'is_active'</span><span style=color:#e1e4e8>, sa.Boolean, </span><span style=color:#ffab70>default</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>),</span></span>
<span class=line><span style=color:#e1e4e8>    )</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Create performance indexes</span></span>
<span class=line><span style=color:#e1e4e8>    op.create_index(</span><span style=color:#9ecbff>'idx_session_active_expiry'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'sessions'</span><span style=color:#e1e4e8>, [</span><span style=color:#9ecbff>'is_active'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'expires_at'</span><span style=color:#e1e4e8>])</span></span>
<span class=line><span style=color:#e1e4e8>    op.create_index(</span><span style=color:#9ecbff>'idx_session_email_active'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'sessions'</span><span style=color:#e1e4e8>, [</span><span style=color:#9ecbff>'email_hash'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'is_active'</span><span style=color:#e1e4e8>])</span></span></code></pre><h2 id=ai-integration-context-aware-responses>AI Integration: Context-Aware Responses</h2><h3 id=litellm-integration-with-context-management>LiteLLM Integration with Context Management</h3><p>Our AI system maintains conversation context while ensuring security:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># ai_utils.py - AI response generation</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> litellm</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> typing </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> List, Dict, Optional</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> app.core.config </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> get_settings</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> AIChatHandler</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#79b8ff> __init__</span><span style=color:#e1e4e8>(self):</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>.settings </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> get_settings()</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>._setup_litellm()</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>._load_prompts()</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#b392f0> _apply_security_preprocessing</span><span style=color:#e1e4e8>(self, user_message: </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>) -> </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#9ecbff>        """Apply security preprocessing to user input"""</span></span>
<span class=line><span style=color:#6a737d>        # Security preprocessing implementation details are proprietary</span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#79b8ff> self</span><span style=color:#e1e4e8>._process_user_input_securely(user_message)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    async</span><span style=color:#f97583> def</span><span style=color:#b392f0> generate_response</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>        self,</span></span>
<span class=line><span style=color:#e1e4e8>        user_message: </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        chat_history: Optional[List[Dict[</span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>]]] </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        is_first_message: </span><span style=color:#79b8ff>bool</span><span style=color:#f97583> =</span><span style=color:#79b8ff> False</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    ) -> </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#9ecbff>        """Generate AI response with conversation context"""</span></span>
<span class=line><span style=color:#f97583>        try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>            # Build message context</span></span>
<span class=line><span style=color:#e1e4e8>            messages </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> []</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Add system prompt</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#79b8ff> self</span><span style=color:#e1e4e8>.system_prompt:</span></span>
<span class=line><span style=color:#e1e4e8>                messages.append({</span><span style=color:#9ecbff>"role"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"system"</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>"content"</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>self</span><span style=color:#e1e4e8>.system_prompt})</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Add conversation history (limit to last 8 messages for context)</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#e1e4e8> chat_history:</span></span>
<span class=line><span style=color:#f97583>                for</span><span style=color:#e1e4e8> msg </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> chat_history[</span><span style=color:#f97583>-</span><span style=color:#79b8ff>8</span><span style=color:#e1e4e8>:]:</span></span>
<span class=line><span style=color:#f97583>                    if</span><span style=color:#e1e4e8> msg.get(</span><span style=color:#9ecbff>"user_message"</span><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#e1e4e8>                        messages.append({</span><span style=color:#9ecbff>"role"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"user"</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>"content"</span><span style=color:#e1e4e8>: msg[</span><span style=color:#9ecbff>"user_message"</span><span style=color:#e1e4e8>]})</span></span>
<span class=line><span style=color:#f97583>                    if</span><span style=color:#e1e4e8> msg.get(</span><span style=color:#9ecbff>"assistant_response"</span><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#e1e4e8>                        messages.append({</span><span style=color:#9ecbff>"role"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"assistant"</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>"content"</span><span style=color:#e1e4e8>: msg[</span><span style=color:#9ecbff>"assistant_response"</span><span style=color:#e1e4e8>]})</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Apply security preprocessing to user input</span></span>
<span class=line><span style=color:#e1e4e8>            protected_message </span><span style=color:#f97583>=</span><span style=color:#79b8ff> self</span><span style=color:#e1e4e8>._apply_security_preprocessing(user_message)</span></span>
<span class=line><span style=color:#e1e4e8>            messages.append({</span><span style=color:#9ecbff>"role"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"user"</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>"content"</span><span style=color:#e1e4e8>: protected_message})</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Generate response using Gemini</span></span>
<span class=line><span style=color:#e1e4e8>            response </span><span style=color:#f97583>=</span><span style=color:#f97583> await</span><span style=color:#e1e4e8> litellm.acompletion(</span></span>
<span class=line><span style=color:#ffab70>                model</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"gemini/gemini-2.5-flash-lite"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                messages</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>messages,</span></span>
<span class=line><span style=color:#ffab70>                temperature</span><span style=color:#f97583>=</span><span style=color:#79b8ff>0.7</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                max_tokens</span><span style=color:#f97583>=</span><span style=color:#79b8ff>500</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                timeout</span><span style=color:#f97583>=</span><span style=color:#79b8ff>30</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>            )</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>            return</span><span style=color:#e1e4e8> response.choices[</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>].message.content</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>        except</span><span style=color:#79b8ff> Exception</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> e:</span></span>
<span class=line><span style=color:#e1e4e8>            logger.error(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"AI generation failed: </span><span style=color:#79b8ff>{str</span><span style=color:#e1e4e8>(e)</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>            return</span><span style=color:#79b8ff> self</span><span style=color:#e1e4e8>._get_fallback_response(user_message)</span></span></code></pre><h2 id=real-time-notifications-discord-integration>Real-time Notifications: Discord Integration</h2><h3 id=asynchronous-discord-notifications>Asynchronous Discord Notifications</h3><p>We implemented a sophisticated Discord notification system that runs asynchronously:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># discord_notifier.py - Real-time Discord integration</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> discord</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> discord.ext </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> commands</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> asyncio</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> typing </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> Dict, Optional</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> loguru </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> logger</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> DiscordNotifier</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#79b8ff> __init__</span><span style=color:#e1e4e8>(self, token: </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>, channel_id: </span><span style=color:#79b8ff>int</span><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>.intents </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> discord.Intents.default()</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>.intents.message_content </span><span style=color:#f97583>=</span><span style=color:#79b8ff> True</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>.bot </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> commands.Bot(</span><span style=color:#ffab70>command_prefix</span><span style=color:#f97583>=</span><span style=color:#9ecbff>'!'</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>intents</span><span style=color:#f97583>=</span><span style=color:#79b8ff>self</span><span style=color:#e1e4e8>.intents)</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>.channel_id </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> channel_id</span></span>
<span class=line><span style=color:#79b8ff>        self</span><span style=color:#e1e4e8>._setup_events()</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    async</span><span style=color:#f97583> def</span><span style=color:#b392f0> create_session_notification</span><span style=color:#e1e4e8>(self, session_data: Dict) -> Optional[</span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>]:</span></span>
<span class=line><span style=color:#9ecbff>        """Create a new Discord thread for a chat session"""</span></span>
<span class=line><span style=color:#f97583>        try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>            channel </span><span style=color:#f97583>=</span><span style=color:#79b8ff> self</span><span style=color:#e1e4e8>.bot.get_channel(</span><span style=color:#79b8ff>self</span><span style=color:#e1e4e8>.channel_id)</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#f97583> not</span><span style=color:#e1e4e8> channel:</span></span>
<span class=line><span style=color:#e1e4e8>                logger.error(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Discord channel </span><span style=color:#79b8ff>{self</span><span style=color:#e1e4e8>.channel_id</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff> not found"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>                return</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Create thread with session information</span></span>
<span class=line><span style=color:#e1e4e8>            thread_name </span><span style=color:#f97583>=</span><span style=color:#f97583> f</span><span style=color:#9ecbff>"Session </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>session_data[</span><span style=color:#9ecbff>'session_id'</span><span style=color:#e1e4e8>][:</span><span style=color:#79b8ff>8</span><span style=color:#e1e4e8>]</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#e1e4e8>            embed </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> discord.Embed(</span></span>
<span class=line><span style=color:#ffab70>                title</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"🚀 New Chat Session"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                color</span><span style=color:#f97583>=0x</span><span style=color:#79b8ff>3366FF</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                timestamp</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>session_data[</span><span style=color:#9ecbff>'created_at'</span><span style=color:#e1e4e8>]</span></span>
<span class=line><span style=color:#e1e4e8>            )</span></span>
<span class=line><span style=color:#e1e4e8>            embed.add_field(</span><span style=color:#ffab70>name</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Session ID"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>value</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>session_data[</span><span style=color:#9ecbff>'session_id'</span><span style=color:#e1e4e8>][:</span><span style=color:#79b8ff>16</span><span style=color:#e1e4e8>], </span><span style=color:#ffab70>inline</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>            embed.add_field(</span><span style=color:#ffab70>name</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Email"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>value</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>session_data.get(</span><span style=color:#9ecbff>'email'</span><span style=color:#e1e4e8>, </span><span style=color:#9ecbff>'Unknown'</span><span style=color:#e1e4e8>)[:</span><span style=color:#79b8ff>20</span><span style=color:#e1e4e8>], </span><span style=color:#ffab70>inline</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>            embed.add_field(</span><span style=color:#ffab70>name</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"IP Address"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>value</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>session_data[</span><span style=color:#9ecbff>'ip_address'</span><span style=color:#e1e4e8>], </span><span style=color:#ffab70>inline</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Create thread and send initial message</span></span>
<span class=line><span style=color:#e1e4e8>            message </span><span style=color:#f97583>=</span><span style=color:#f97583> await</span><span style=color:#e1e4e8> channel.send(</span><span style=color:#ffab70>embed</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>embed)</span></span>
<span class=line><span style=color:#e1e4e8>            thread </span><span style=color:#f97583>=</span><span style=color:#f97583> await</span><span style=color:#e1e4e8> message.create_thread(</span></span>
<span class=line><span style=color:#ffab70>                name</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>thread_name,</span></span>
<span class=line><span style=color:#ffab70>                auto_archive_duration</span><span style=color:#f97583>=</span><span style=color:#79b8ff>1440</span><span style=color:#6a737d>  # 24 hours</span></span>
<span class=line><span style=color:#e1e4e8>            )</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#e1e4e8>            logger.info(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Created Discord thread </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>thread.id</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff> for session </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>session_data[</span><span style=color:#9ecbff>'session_id'</span><span style=color:#e1e4e8>]</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>            return</span><span style=color:#79b8ff> str</span><span style=color:#e1e4e8>(thread.id)</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>        except</span><span style=color:#79b8ff> Exception</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> e:</span></span>
<span class=line><span style=color:#e1e4e8>            logger.error(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Failed to create Discord thread: </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>e</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>            return</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    async</span><span style=color:#f97583> def</span><span style=color:#b392f0> update_message_notification</span><span style=color:#e1e4e8>(self, thread_id: </span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>, message_data: Dict) -> </span><span style=color:#79b8ff>bool</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#9ecbff>        """Send message update to Discord thread"""</span></span>
<span class=line><span style=color:#f97583>        try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>            thread </span><span style=color:#f97583>=</span><span style=color:#79b8ff> self</span><span style=color:#e1e4e8>.bot.get_channel(</span><span style=color:#79b8ff>int</span><span style=color:#e1e4e8>(thread_id))</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#f97583> not</span><span style=color:#e1e4e8> thread:</span></span>
<span class=line><span style=color:#e1e4e8>                logger.error(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Discord thread </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>thread_id</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff> not found"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>                return</span><span style=color:#79b8ff> False</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Format message based on type</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#e1e4e8> message_data[</span><span style=color:#9ecbff>'message_type'</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>==</span><span style=color:#9ecbff> 'user'</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>                embed </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> discord.Embed(</span></span>
<span class=line><span style=color:#ffab70>                    title</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"👤 User Message"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                    description</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>message_data[</span><span style=color:#9ecbff>'content'</span><span style=color:#e1e4e8>][:</span><span style=color:#79b8ff>1000</span><span style=color:#e1e4e8>],</span></span>
<span class=line><span style=color:#ffab70>                    color</span><span style=color:#f97583>=0x</span><span style=color:#79b8ff>00FF00</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                    timestamp</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>message_data[</span><span style=color:#9ecbff>'timestamp'</span><span style=color:#e1e4e8>]</span></span>
<span class=line><span style=color:#e1e4e8>                )</span></span>
<span class=line><span style=color:#f97583>            else</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>                embed </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> discord.Embed(</span></span>
<span class=line><span style=color:#ffab70>                    title</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"🤖 Assistant Response"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                    description</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>message_data[</span><span style=color:#9ecbff>'content'</span><span style=color:#e1e4e8>][:</span><span style=color:#79b8ff>1000</span><span style=color:#e1e4e8>],</span></span>
<span class=line><span style=color:#ffab70>                    color</span><span style=color:#f97583>=0x</span><span style=color:#79b8ff>FF9900</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                    timestamp</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>message_data[</span><span style=color:#9ecbff>'timestamp'</span><span style=color:#e1e4e8>]</span></span>
<span class=line><span style=color:#e1e4e8>                )</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#e1e4e8>            embed.add_field(</span><span style=color:#ffab70>name</span><span style=color:#f97583>=</span><span style=color:#9ecbff>"Message ID"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>value</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>message_data[</span><span style=color:#9ecbff>'message_id'</span><span style=color:#e1e4e8>], </span><span style=color:#ffab70>inline</span><span style=color:#f97583>=</span><span style=color:#79b8ff>True</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>            await</span><span style=color:#e1e4e8> thread.send(</span><span style=color:#ffab70>embed</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>embed)</span></span>
<span class=line><span style=color:#f97583>            return</span><span style=color:#79b8ff> True</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>        except</span><span style=color:#79b8ff> Exception</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> e:</span></span>
<span class=line><span style=color:#e1e4e8>            logger.error(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Failed to send Discord notification: </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>e</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>            return</span><span style=color:#79b8ff> False</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d># Async background task integration</span></span>
<span class=line><span style=color:#f97583>async</span><span style=color:#f97583> def</span><span style=color:#b392f0> handle_discord_notifications</span><span style=color:#e1e4e8>(session_data: Dict, message_data: Dict):</span></span>
<span class=line><span style=color:#9ecbff>    """Background task for Discord notifications"""</span></span>
<span class=line><span style=color:#f97583>    try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>        # Small delay to ensure database consistency</span></span>
<span class=line><span style=color:#f97583>        await</span><span style=color:#e1e4e8> asyncio.sleep(</span><span style=color:#79b8ff>1.0</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Create new database session for background task</span></span>
<span class=line><span style=color:#f97583>        from</span><span style=color:#e1e4e8> app.dependencies.database </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> get_db</span></span>
<span class=line><span style=color:#e1e4e8>        background_db </span><span style=color:#f97583>=</span><span style=color:#79b8ff> next</span><span style=color:#e1e4e8>(get_db())</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#f97583>        try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>            # Update Discord thread and send notifications</span></span>
<span class=line><span style=color:#e1e4e8>            discord_notifier </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> DiscordNotifier(</span></span>
<span class=line><span style=color:#ffab70>                token</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>settings.</span><span style=color:#79b8ff>DISCORD_BOT_TOKEN</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#ffab70>                channel_id</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>settings.</span><span style=color:#79b8ff>DISCORD_CHANNEL_ID</span></span>
<span class=line><span style=color:#e1e4e8>            )</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>            await</span><span style=color:#e1e4e8> discord_notifier.update_message_notification(</span></span>
<span class=line><span style=color:#e1e4e8>                session_data[</span><span style=color:#9ecbff>'discord_thread_id'</span><span style=color:#e1e4e8>],</span></span>
<span class=line><span style=color:#e1e4e8>                message_data</span></span>
<span class=line><span style=color:#e1e4e8>            )</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>        finally</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>            background_db.close()</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>    except</span><span style=color:#79b8ff> Exception</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> e:</span></span>
<span class=line><span style=color:#e1e4e8>        logger.error(</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Discord notification failed: </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>e</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span></code></pre><h2 id=message-history-management-solving-the-duplicate-bug>Message History Management: Solving the Duplicate Bug</h2><h3 id=the-problem-and-solution>The Problem and Solution</h3><p>We discovered a critical bug in our message history endpoint where assistant responses were being duplicated. The issue was in the pairing logic:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># BEFORE: Buggy implementation</span></span>
<span class=line><span style=color:#f97583>for</span><span style=color:#e1e4e8> msg </span><span style=color:#f97583>in</span><span style=color:#79b8ff> reversed</span><span style=color:#e1e4e8>(db_messages):</span></span>
<span class=line><span style=color:#f97583>    if</span><span style=color:#e1e4e8> msg.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "user"</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>        assistant_response </span><span style=color:#f97583>=</span><span style=color:#79b8ff> next</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>            (m </span><span style=color:#f97583>for</span><span style=color:#e1e4e8> m </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> db_messages </span></span>
<span class=line><span style=color:#f97583>             if</span><span style=color:#e1e4e8> m.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "assistant"</span><span style=color:#f97583> and</span><span style=color:#e1e4e8> m.timestamp </span><span style=color:#f97583>>=</span><span style=color:#e1e4e8> msg.timestamp),</span></span>
<span class=line><span style=color:#79b8ff>            None</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>        )</span></span>
<span class=line><span style=color:#6a737d>        # This could return the same assistant message for multiple users!</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d># AFTER: Fixed implementation</span></span>
<span class=line><span style=color:#e1e4e8>message_objects </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> []</span></span>
<span class=line><span style=color:#e1e4e8>used_assistant_ids </span><span style=color:#f97583>=</span><span style=color:#79b8ff> set</span><span style=color:#e1e4e8>()  </span><span style=color:#6a737d># Track which assistant messages have been used</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>for</span><span style=color:#e1e4e8> msg </span><span style=color:#f97583>in</span><span style=color:#79b8ff> reversed</span><span style=color:#e1e4e8>(db_messages):</span></span>
<span class=line><span style=color:#f97583>    if</span><span style=color:#e1e4e8> msg.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "user"</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>        # Find the closest unused assistant response</span></span>
<span class=line><span style=color:#e1e4e8>        assistant_response </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> m </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> db_messages:</span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#e1e4e8> (m.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "assistant"</span><span style=color:#e1e4e8> </span></span>
<span class=line><span style=color:#f97583>                and</span><span style=color:#e1e4e8> m.timestamp </span><span style=color:#f97583>>=</span><span style=color:#e1e4e8> msg.timestamp </span></span>
<span class=line><span style=color:#f97583>                and</span><span style=color:#e1e4e8> m.id </span><span style=color:#f97583>not</span><span style=color:#f97583> in</span><span style=color:#e1e4e8> used_assistant_ids):</span></span>
<span class=line><span style=color:#f97583>                if</span><span style=color:#e1e4e8> assistant_response </span><span style=color:#f97583>is</span><span style=color:#79b8ff> None</span><span style=color:#f97583> or</span><span style=color:#e1e4e8> m.timestamp </span><span style=color:#f97583>&#x3C;</span><span style=color:#e1e4e8> assistant_response.timestamp:</span></span>
<span class=line><span style=color:#e1e4e8>                    assistant_response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> m</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Mark this assistant response as used</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> assistant_response:</span></span>
<span class=line><span style=color:#e1e4e8>            used_assistant_ids.add(assistant_response.id)</span></span>
<span class=line><span style=color:#e1e4e8>            response_text </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> assistant_response.content</span></span>
<span class=line><span style=color:#f97583>        else</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>            response_text </span><span style=color:#f97583>=</span><span style=color:#9ecbff> ""</span></span></code></pre><p>This fix ensures each assistant message is paired with exactly one user message, eliminating duplicates.</p><h2 id=testing-strategy-comprehensive-coverage>Testing Strategy: Comprehensive Coverage</h2><h3 id=environment-isolated-testing>Environment-Isolated Testing</h3><p>Our testing strategy uses environment isolation to test different security modes:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># tests/test_api_pytest.py</span></span>
<span class=line><span style=color:#f97583>import</span><span style=color:#e1e4e8> pytest</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> fastapi.testclient </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> TestClient</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> app.main </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> app</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> app.core.config </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> get_settings</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> TestChatFunctionality</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#9ecbff>    """Test chat API with authentication"""</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#b392f0>    @pytest.fixture</span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#b392f0> authenticated_client</span><span style=color:#e1e4e8>(self):</span></span>
<span class=line><span style=color:#9ecbff>        """Create authenticated test client"""</span></span>
<span class=line><span style=color:#e1e4e8>        client </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> TestClient(app)</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Create test session</span></span>
<span class=line><span style=color:#e1e4e8>        auth_response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> client.post(</span><span style=color:#9ecbff>"/auth/email"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>json</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{</span></span>
<span class=line><span style=color:#9ecbff>            "email"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"test@example.com"</span></span>
<span class=line><span style=color:#e1e4e8>        })</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> auth_response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 200</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#e1e4e8>        token </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> auth_response.json()[</span><span style=color:#9ecbff>"access_token"</span><span style=color:#e1e4e8>]</span></span>
<span class=line><span style=color:#e1e4e8>        client.headers.update({</span><span style=color:#9ecbff>"Authorization"</span><span style=color:#e1e4e8>: </span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Bearer </span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>token</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>})</span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#e1e4e8> client</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#b392f0> test_chat_message_flow</span><span style=color:#e1e4e8>(self, authenticated_client):</span></span>
<span class=line><span style=color:#9ecbff>        """Test complete chat message flow"""</span></span>
<span class=line><span style=color:#6a737d>        # Send chat message</span></span>
<span class=line><span style=color:#e1e4e8>        chat_response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> authenticated_client.post(</span><span style=color:#9ecbff>"/chat"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>json</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{</span></span>
<span class=line><span style=color:#9ecbff>            "message"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"Hello, how can you help me?"</span></span>
<span class=line><span style=color:#e1e4e8>        })</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> chat_response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 200</span></span>
<span class=line><span style=color:#e1e4e8>        data </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> chat_response.json()</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> data[</span><span style=color:#9ecbff>"success"</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>is</span><span style=color:#79b8ff> True</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#79b8ff> len</span><span style=color:#e1e4e8>(data[</span><span style=color:#9ecbff>"response"</span><span style=color:#e1e4e8>]) </span><span style=color:#f97583>></span><span style=color:#79b8ff> 0</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#9ecbff> "message_id"</span><span style=color:#f97583> in</span><span style=color:#e1e4e8> data</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Verify message history</span></span>
<span class=line><span style=color:#e1e4e8>        history_response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> authenticated_client.get(</span><span style=color:#9ecbff>"/chat/history?limit=10"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> history_response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 200</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#e1e4e8>        history_data </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> history_response.json()</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#79b8ff> len</span><span style=color:#e1e4e8>(history_data[</span><span style=color:#9ecbff>"messages"</span><span style=color:#e1e4e8>]) </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 1</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> history_data[</span><span style=color:#9ecbff>"messages"</span><span style=color:#e1e4e8>][</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>][</span><span style=color:#9ecbff>"message"</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "Hello, how can you help me?"</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#79b8ff> len</span><span style=color:#e1e4e8>(history_data[</span><span style=color:#9ecbff>"messages"</span><span style=color:#e1e4e8>][</span><span style=color:#79b8ff>0</span><span style=color:#e1e4e8>][</span><span style=color:#9ecbff>"response"</span><span style=color:#e1e4e8>]) </span><span style=color:#f97583>></span><span style=color:#79b8ff> 0</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#b392f0> test_input_sanitization</span><span style=color:#e1e4e8>(self, authenticated_client):</span></span>
<span class=line><span style=color:#9ecbff>        """Test XSS and injection protection"""</span></span>
<span class=line><span style=color:#e1e4e8>        malicious_inputs </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> [</span></span>
<span class=line><span style=color:#9ecbff>            "&#x3C;script>alert('xss')&#x3C;/script>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "'; DROP TABLE users; --"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "</span><span style=color:#79b8ff>{{</span><span style=color:#9ecbff>constructor.constructor('return process')().exit()</span><span style=color:#79b8ff>}}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "../../../etc/passwd"</span></span>
<span class=line><span style=color:#e1e4e8>        ]</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> malicious_input </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> malicious_inputs:</span></span>
<span class=line><span style=color:#e1e4e8>            response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> authenticated_client.post(</span><span style=color:#9ecbff>"/chat"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>json</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{</span></span>
<span class=line><span style=color:#9ecbff>                "message"</span><span style=color:#e1e4e8>: malicious_input</span></span>
<span class=line><span style=color:#e1e4e8>            })</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Should not reject but should sanitize</span></span>
<span class=line><span style=color:#f97583>            assert</span><span style=color:#e1e4e8> response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 200</span></span>
<span class=line><span style=color:#e1e4e8>            data </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> response.json()</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#6a737d>            # Response should indicate safety handling</span></span>
<span class=line><span style=color:#f97583>            assert</span><span style=color:#9ecbff> "safety"</span><span style=color:#f97583> in</span><span style=color:#e1e4e8> data[</span><span style=color:#9ecbff>"response"</span><span style=color:#e1e4e8>].lower() </span><span style=color:#f97583>or</span><span style=color:#9ecbff> "rephrase"</span><span style=color:#f97583> in</span><span style=color:#e1e4e8> data[</span><span style=color:#9ecbff>"response"</span><span style=color:#e1e4e8>].lower()</span></span></code></pre><h3 id=security-testing-in-production-mode>Security Testing in Production Mode</h3><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># tests/test_security.py</span></span>
<span class=line><span style=color:#b392f0>@pytest.mark.asyncio</span></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> TestSecurityFeatures</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#9ecbff>    """Test security features in production mode"""</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#b392f0> test_rate_limiting</span><span style=color:#e1e4e8>(self):</span></span>
<span class=line><span style=color:#9ecbff>        """Test rate limiting enforcement"""</span></span>
<span class=line><span style=color:#e1e4e8>        client </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> TestClient(app)</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Exceed rate limit</span></span>
<span class=line><span style=color:#f97583>        for</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>in</span><span style=color:#79b8ff> range</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>15</span><span style=color:#e1e4e8>):  </span><span style=color:#6a737d># Limit is 10/minute</span></span>
<span class=line><span style=color:#e1e4e8>            response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> client.post(</span><span style=color:#9ecbff>"/auth/email"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>json</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{</span></span>
<span class=line><span style=color:#9ecbff>                "email"</span><span style=color:#e1e4e8>: </span><span style=color:#f97583>f</span><span style=color:#9ecbff>"test</span><span style=color:#79b8ff>{</span><span style=color:#e1e4e8>i</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>@example.com"</span></span>
<span class=line><span style=color:#e1e4e8>            })</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#e1e4e8> i </span><span style=color:#f97583>&#x3C;</span><span style=color:#79b8ff> 10</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#f97583>                assert</span><span style=color:#e1e4e8> response.status_code </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> [</span><span style=color:#79b8ff>200</span><span style=color:#e1e4e8>, </span><span style=color:#79b8ff>201</span><span style=color:#e1e4e8>]</span></span>
<span class=line><span style=color:#f97583>            else</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#f97583>                assert</span><span style=color:#e1e4e8> response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 429</span><span style=color:#6a737d>  # Too Many Requests</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    def</span><span style=color:#b392f0> test_jwt_security</span><span style=color:#e1e4e8>(self, authenticated_client):</span></span>
<span class=line><span style=color:#9ecbff>        """Test JWT token validation"""</span></span>
<span class=line><span style=color:#6a737d>        # Test with invalid token</span></span>
<span class=line><span style=color:#e1e4e8>        client </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> TestClient(app)</span></span>
<span class=line><span style=color:#e1e4e8>        client.headers.update({</span><span style=color:#9ecbff>"Authorization"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"Bearer invalid_token"</span><span style=color:#e1e4e8>})</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#e1e4e8>        response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> client.post(</span><span style=color:#9ecbff>"/chat"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>json</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{</span><span style=color:#9ecbff>"message"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"test"</span><span style=color:#e1e4e8>})</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 401</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Test with expired token (would need time manipulation in real test)</span></span>
<span class=line><span style=color:#6a737d>        # Test with malformed token</span></span>
<span class=line><span style=color:#e1e4e8>        client.headers.update({</span><span style=color:#9ecbff>"Authorization"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"Bearer malformed.token.here"</span><span style=color:#e1e4e8>})</span></span>
<span class=line><span style=color:#e1e4e8>        response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> client.post(</span><span style=color:#9ecbff>"/chat"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>json</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>{</span><span style=color:#9ecbff>"message"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"test"</span><span style=color:#e1e4e8>})</span></span>
<span class=line><span style=color:#f97583>        assert</span><span style=color:#e1e4e8> response.status_code </span><span style=color:#f97583>==</span><span style=color:#79b8ff> 401</span></span></code></pre><h2 id=performance-optimization-sub-200ms-responses>Performance Optimization: Sub-200ms Responses</h2><h3 id=database-query-optimization>Database Query Optimization</h3><p>We optimized database queries for chat history retrieval:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># Optimized chat history query</span></span>
<span class=line><span style=color:#b392f0>@router.get</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>"/history"</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>response_model</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>ChatHistoryResponse)</span></span>
<span class=line><span style=color:#f97583>async</span><span style=color:#f97583> def</span><span style=color:#b392f0> get_chat_history</span><span style=color:#e1e4e8>(</span></span>
<span class=line><span style=color:#e1e4e8>    current_user: Dict </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Depends(get_current_user),</span></span>
<span class=line><span style=color:#e1e4e8>    limit: </span><span style=color:#79b8ff>int</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 50</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#e1e4e8>    db: Session </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Depends(get_db),</span></span>
<span class=line><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#9ecbff>    """Optimized chat history retrieval"""</span></span>
<span class=line><span style=color:#e1e4e8>    session_id </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> current_user.get(</span><span style=color:#9ecbff>"jti"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Single optimized query with proper indexing</span></span>
<span class=line><span style=color:#e1e4e8>    query </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> (</span></span>
<span class=line><span style=color:#e1e4e8>        db.query(DBChatMessage)</span></span>
<span class=line><span style=color:#e1e4e8>        .filter(DBChatMessage.session_id </span><span style=color:#f97583>==</span><span style=color:#e1e4e8> session_id)</span></span>
<span class=line><span style=color:#e1e4e8>        .order_by(DBChatMessage.timestamp.desc())</span></span>
<span class=line><span style=color:#e1e4e8>    )</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    if</span><span style=color:#e1e4e8> limit </span><span style=color:#f97583>></span><span style=color:#79b8ff> 0</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>        query </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> query.limit(limit)</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Execute with optimized indexes</span></span>
<span class=line><span style=color:#e1e4e8>    db_messages </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> query.all()  </span><span style=color:#6a737d># Uses idx_message_session_time index</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Efficient pairing algorithm (O(n) complexity)</span></span>
<span class=line><span style=color:#e1e4e8>    message_objects </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> []</span></span>
<span class=line><span style=color:#e1e4e8>    used_assistant_ids </span><span style=color:#f97583>=</span><span style=color:#79b8ff> set</span><span style=color:#e1e4e8>()</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    for</span><span style=color:#e1e4e8> msg </span><span style=color:#f97583>in</span><span style=color:#79b8ff> reversed</span><span style=color:#e1e4e8>(db_messages):</span></span>
<span class=line><span style=color:#f97583>        if</span><span style=color:#e1e4e8> msg.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "user"</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>            # Find closest unused assistant response</span></span>
<span class=line><span style=color:#e1e4e8>            assistant_response </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#f97583>            for</span><span style=color:#e1e4e8> m </span><span style=color:#f97583>in</span><span style=color:#e1e4e8> db_messages:</span></span>
<span class=line><span style=color:#f97583>                if</span><span style=color:#e1e4e8> (m.message_type </span><span style=color:#f97583>==</span><span style=color:#9ecbff> "assistant"</span><span style=color:#e1e4e8> </span></span>
<span class=line><span style=color:#f97583>                    and</span><span style=color:#e1e4e8> m.timestamp </span><span style=color:#f97583>>=</span><span style=color:#e1e4e8> msg.timestamp </span></span>
<span class=line><span style=color:#f97583>                    and</span><span style=color:#e1e4e8> m.id </span><span style=color:#f97583>not</span><span style=color:#f97583> in</span><span style=color:#e1e4e8> used_assistant_ids):</span></span>
<span class=line><span style=color:#f97583>                    if</span><span style=color:#e1e4e8> assistant_response </span><span style=color:#f97583>is</span><span style=color:#79b8ff> None</span><span style=color:#f97583> or</span><span style=color:#e1e4e8> m.timestamp </span><span style=color:#f97583>&#x3C;</span><span style=color:#e1e4e8> assistant_response.timestamp:</span></span>
<span class=line><span style=color:#e1e4e8>                        assistant_response </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> m</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#f97583>            if</span><span style=color:#e1e4e8> assistant_response:</span></span>
<span class=line><span style=color:#e1e4e8>                used_assistant_ids.add(assistant_response.id)</span></span>
<span class=line><span style=color:#e1e4e8>                response_text </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> assistant_response.content</span></span>
<span class=line><span style=color:#f97583>            else</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>                response_text </span><span style=color:#f97583>=</span><span style=color:#9ecbff> ""</span></span>
<span class=line><span style=color:#e1e4e8>            </span></span>
<span class=line><span style=color:#e1e4e8>            message_objects.append(ChatMessage(</span></span>
<span class=line><span style=color:#ffab70>                id</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>msg.id,</span></span>
<span class=line><span style=color:#ffab70>                message</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>msg.content,</span></span>
<span class=line><span style=color:#ffab70>                response</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>response_text,</span></span>
<span class=line><span style=color:#ffab70>                timestamp</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>msg.timestamp.isoformat(),</span></span>
<span class=line><span style=color:#ffab70>                browser_hash</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>session.browser_hash,</span></span>
<span class=line><span style=color:#ffab70>                ip_address</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>session.ip_address,</span></span>
<span class=line><span style=color:#e1e4e8>            ))</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8> ChatHistoryResponse(</span><span style=color:#ffab70>messages</span><span style=color:#f97583>=</span><span style=color:#e1e4e8>message_objects, </span><span style=color:#79b8ff>...</span><span style=color:#e1e4e8>)</span></span></code></pre><h3 id=asynchronous-processing>Asynchronous Processing</h3><p>We use background tasks for non-critical operations:</p><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># Background Discord notifications</span></span>
<span class=line><span style=color:#e1e4e8>asyncio.create_task(handle_discord_notifications())</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d># This ensures chat responses aren't blocked by Discord API calls</span></span></code></pre><h2 id=deployment-and-monitoring>Deployment and Monitoring</h2><h3 id=production-configuration>Production Configuration</h3><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># app/core/config.py - Environment-aware configuration</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> pydantic </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> BaseSettings</span></span>
<span class=line><span style=color:#f97583>from</span><span style=color:#e1e4e8> typing </span><span style=color:#f97583>import</span><span style=color:#e1e4e8> Optional</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>class</span><span style=color:#b392f0> Settings</span><span style=color:#e1e4e8>(</span><span style=color:#b392f0>BaseSettings</span><span style=color:#e1e4e8>):</span></span>
<span class=line><span style=color:#9ecbff>    """Environment-aware configuration"""</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Database</span></span>
<span class=line><span style=color:#79b8ff>    DATABASE_URL</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>str</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "sqlite:///./chat_app.db"</span><span style=color:#6a737d>  # Development</span></span>
<span class=line><span style=color:#79b8ff>    DATABASE_URL_PROD</span><span style=color:#e1e4e8>: Optional[</span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span><span style=color:#6a737d>  # Production PostgreSQL</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Security</span></span>
<span class=line><span style=color:#79b8ff>    JWT_SECRET_KEY</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>str</span></span>
<span class=line><span style=color:#79b8ff>    JWT_ALGORITHM</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>str</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "HS256"</span></span>
<span class=line><span style=color:#79b8ff>    JWT_EXPIRE_HOURS</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>int</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 24</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Rate limiting</span></span>
<span class=line><span style=color:#79b8ff>    RATE_LIMITING_ENABLED</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>bool</span><span style=color:#f97583> =</span><span style=color:#79b8ff> True</span></span>
<span class=line><span style=color:#79b8ff>    CHAT_RATE_LIMIT</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>str</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "10/minute"</span></span>
<span class=line><span style=color:#79b8ff>    AUTH_RATE_LIMIT</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>str</span><span style=color:#f97583> =</span><span style=color:#9ecbff> "5/minute"</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Bot detection</span></span>
<span class=line><span style=color:#79b8ff>    BOT_DETECTION_ENABLED</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>bool</span><span style=color:#f97583> =</span><span style=color:#79b8ff> True</span></span>
<span class=line><span style=color:#79b8ff>    MIN_USER_AGENT_LENGTH</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>int</span><span style=color:#f97583> =</span><span style=color:#79b8ff> 10</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # AI Integration</span></span>
<span class=line><span style=color:#79b8ff>    GOOGLE_API_KEY</span><span style=color:#e1e4e8>: Optional[</span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#6a737d>    # Discord Integration</span></span>
<span class=line><span style=color:#79b8ff>    DISCORD_ENABLED</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>bool</span><span style=color:#f97583> =</span><span style=color:#79b8ff> False</span></span>
<span class=line><span style=color:#79b8ff>    DISCORD_BOT_TOKEN</span><span style=color:#e1e4e8>: Optional[</span><span style=color:#79b8ff>str</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#79b8ff>    DISCORD_CHANNEL_ID</span><span style=color:#e1e4e8>: Optional[</span><span style=color:#79b8ff>int</span><span style=color:#e1e4e8>] </span><span style=color:#f97583>=</span><span style=color:#79b8ff> None</span></span>
<span class=line><span style=color:#79b8ff>    DISCORD_NOTIFY_MESSAGES</span><span style=color:#e1e4e8>: </span><span style=color:#79b8ff>bool</span><span style=color:#f97583> =</span><span style=color:#79b8ff> True</span></span>
<span class=line><span style=color:#e1e4e8>    </span></span>
<span class=line><span style=color:#f97583>    class</span><span style=color:#b392f0> Config</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#e1e4e8>        env_file </span><span style=color:#f97583>=</span><span style=color:#9ecbff> ".env"</span></span>
<span class=line><span style=color:#e1e4e8>        case_sensitive </span><span style=color:#f97583>=</span><span style=color:#79b8ff> True</span></span>
<span class=line></span>
<span class=line><span style=color:#f97583>def</span><span style=color:#b392f0> get_settings</span><span style=color:#e1e4e8>() -> Settings:</span></span>
<span class=line><span style=color:#9ecbff>    """Get environment-specific settings"""</span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8> Settings()</span></span></code></pre><h3 id=health-monitoring>Health Monitoring</h3><pre class="astro-code github-dark" data-language=python style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d># app/routers/system.py - Health checks</span></span>
<span class=line><span style=color:#b392f0>@router.get</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>"/health"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#f97583>async</span><span style=color:#f97583> def</span><span style=color:#b392f0> health_check</span><span style=color:#e1e4e8>(db: Session </span><span style=color:#f97583>=</span><span style=color:#e1e4e8> Depends(get_db)):</span></span>
<span class=line><span style=color:#9ecbff>    """Comprehensive health check"""</span></span>
<span class=line><span style=color:#f97583>    try</span><span style=color:#e1e4e8>:</span></span>
<span class=line><span style=color:#6a737d>        # Test database connection</span></span>
<span class=line><span style=color:#e1e4e8>        db.execute(</span><span style=color:#9ecbff>"SELECT 1"</span><span style=color:#e1e4e8>)</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#6a737d>        # Test AI service</span></span>
<span class=line><span style=color:#e1e4e8>        ai_status </span><span style=color:#f97583>=</span><span style=color:#9ecbff> "available"</span><span style=color:#f97583> if</span><span style=color:#e1e4e8> os.getenv(</span><span style=color:#9ecbff>"GOOGLE_API_KEY"</span><span style=color:#e1e4e8>) </span><span style=color:#f97583>else</span><span style=color:#9ecbff> "unavailable"</span></span>
<span class=line><span style=color:#e1e4e8>        </span></span>
<span class=line><span style=color:#f97583>        return</span><span style=color:#e1e4e8> {</span></span>
<span class=line><span style=color:#9ecbff>            "status"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"healthy"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "timestamp"</span><span style=color:#e1e4e8>: datetime.utcnow().isoformat(),</span></span>
<span class=line><span style=color:#9ecbff>            "database"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"connected"</span><span style=color:#e1e4e8>,</span></span>
<span class=line><span style=color:#9ecbff>            "ai_service"</span><span style=color:#e1e4e8>: ai_status,</span></span>
<span class=line><span style=color:#9ecbff>            "version"</span><span style=color:#e1e4e8>: </span><span style=color:#9ecbff>"1.0.0"</span></span>
<span class=line><span style=color:#e1e4e8>        }</span></span>
<span class=line><span style=color:#f97583>    except</span><span style=color:#79b8ff> Exception</span><span style=color:#f97583> as</span><span style=color:#e1e4e8> e:</span></span>
<span class=line><span style=color:#f97583>        raise</span><span style=color:#e1e4e8> HTTPException(</span><span style=color:#ffab70>status_code</span><span style=color:#f97583>=</span><span style=color:#79b8ff>503</span><span style=color:#e1e4e8>, </span><span style=color:#ffab70>detail</span><span style=color:#f97583>=</span><span style=color:#f97583>f</span><span style=color:#9ecbff>"Health check failed: </span><span style=color:#79b8ff>{str</span><span style=color:#e1e4e8>(e)</span><span style=color:#79b8ff>}</span><span style=color:#9ecbff>"</span><span style=color:#e1e4e8>)</span></span></code></pre><h2 id=results-performance-and-security-metrics>Results: Performance and Security Metrics</h2><p>Our implementation delivers exceptional performance and security:</p><h3 id=performance-metrics>Performance Metrics</h3><ul><li><strong>Response Time</strong>: Sub-200ms for chat messages</li><li><strong>Database Queries</strong>: Optimized with proper indexing (&#x3C; 50ms)</li><li><strong>Concurrent Users</strong>: Tested up to 100 simultaneous sessions</li><li><strong>Memory Usage</strong>: &#x3C; 100MB under normal load</li></ul><h3 id=security-features>Security Features</h3><ul><li><strong>Authentication</strong>: JWT with session management</li><li><strong>Input Validation</strong>: Comprehensive sanitization against XSS, SQL injection, command injection</li><li><strong>Rate Limiting</strong>: Per-IP and per-session limits</li><li><strong>Bot Detection</strong>: User-agent and behavior analysis</li><li><strong>Message Limits</strong>: 50 messages per session maximum</li></ul><h3 id=reliability-features>Reliability Features</h3><ul><li><strong>Error Handling</strong>: Graceful degradation for all failure modes</li><li><strong>Logging</strong>: Structured logging with correlation IDs</li><li><strong>Monitoring</strong>: Real-time Discord notifications</li><li><strong>Testing</strong>: 95%+ code coverage across all modules</li></ul><h2 id=lessons-learned-and-best-practices>Lessons Learned and Best Practices</h2><h3 id=1-security-is-architecture-not-a-feature>1. Security is Architecture, Not a Feature</h3><p>Building security into the foundation rather than adding it later prevented numerous vulnerabilities and simplified implementation.</p><h3 id=2-async-background-tasks-improve-ux>2. Async Background Tasks Improve UX</h3><p>Moving non-critical operations like Discord notifications to background tasks dramatically improved response times.</p><h3 id=3-database-indexing-is-critical>3. Database Indexing is Critical</h3><p>Proper database indexing reduced query times from 500ms to under 50ms for chat history retrieval.</p><h3 id=4-input-sanitization-requires-multiple-layers>4. Input Sanitization Requires Multiple Layers</h3><p>No single sanitization approach catches all attack vectors—defense in depth is essential.</p><h3 id=5-testing-environments-must-mirror-production>5. Testing Environments Must Mirror Production</h3><p>Environment-specific testing revealed issues that unit tests missed.</p><h2 id=looking-forward-future-enhancements>Looking Forward: Future Enhancements</h2><p>Our architecture supports future enhancements:</p><ul><li><strong>WebSocket Integration</strong> for real-time messaging</li><li><strong>Message Encryption</strong> for end-to-end security</li><li><strong>AI Model Fine-tuning</strong> for domain-specific responses</li><li><strong>Horizontal Scaling</strong> with Redis session management</li><li><strong>Analytics Integration</strong> for conversation insights</li></ul><h2 id=conclusion>Conclusion</h2><p>Building a production-ready chat API taught us that every architectural decision has security, performance, and maintenance implications. Our approach of building security and performance into the foundation rather than adding them later proved invaluable.</p><p>The key to our success was treating security, performance, and reliability as first-class architectural concerns. Every component—from JWT authentication to database schema design—was built with these principles in mind.</p><p>As AI becomes increasingly integrated into enterprise applications, the patterns we’ve outlined here provide a foundation for building secure, scalable, and maintainable chat systems. The future of AI-powered applications depends on getting these fundamentals right.</p><hr><p><em>Interested in implementing similar patterns? Our API is designed with modularity in mind, making it easy to adapt these patterns to your specific requirements.</em></p><h2 id=technical-specifications>Technical Specifications</h2><ul><li><strong>Framework</strong>: FastAPI 0.115.4 with Uvicorn ASGI server</li><li><strong>Database</strong>: SQLAlchemy 2.0 with Alembic migrations</li><li><strong>Authentication</strong>: JWT with session management</li><li><strong>AI Integration</strong>: LiteLLM with Google Gemini</li><li><strong>Real-time</strong>: Discord.py for notifications</li><li><strong>Security</strong>: nh3 sanitization, SlowAPI rate limiting</li><li><strong>Testing</strong>: Pytest with 95%+ coverage</li><li><strong>Performance</strong>: Sub-200ms response times</li></ul></div><footer class="border-gray-200 border-t mt-16 pt-8" data-astro-cid-7jjqptxk><div data-astro-cid-7jjqptxk class="flex items-center justify-between"><div data-astro-cid-7jjqptxk class="flex items-center gap-6"><button class="font-sans items-center flex border border-gray-300 gap-2 hover:bg-gray-50 px-4 py-2 rounded-lg transition-colors" data-astro-cid-7jjqptxk><svg class="text-gray-600 h-5 w-5" data-astro-cid-7jjqptxk fill=none stroke=currentColor viewBox="0 0 24 24"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" data-astro-cid-7jjqptxk stroke-linecap=round stroke-linejoin=round stroke-width=2></path></svg> <span class="font-medium text-gray-700 text-sm" data-astro-cid-7jjqptxk>12</span></button> <button class="font-sans items-center flex border border-gray-300 gap-2 hover:bg-gray-50 px-4 py-2 rounded-lg transition-colors" data-astro-cid-7jjqptxk><svg class="text-gray-600 h-5 w-5" data-astro-cid-7jjqptxk fill=none stroke=currentColor viewBox="0 0 24 24"><path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" data-astro-cid-7jjqptxk stroke-linecap=round stroke-linejoin=round stroke-width=2></path></svg> <span class="font-medium text-gray-700 text-sm" data-astro-cid-7jjqptxk>3</span></button></div><div data-astro-cid-7jjqptxk class="flex items-center gap-3"><a class="font-sans font-medium text-gray-700 hover:text-gray-900 px-6 py-2 text-sm transition-colors" href=/webtest/resources/technical-blog data-astro-cid-7jjqptxk>More Articles </a><a class="font-sans font-medium text-sm transition-colors px-6 py-2 bg-gray-900 hover:bg-gray-800 rounded-lg text-white" href=/webtest/contact data-astro-cid-7jjqptxk>Get In Touch</a></div></div></footer></article></main></main></body></html><script type=application/ld+json>{ "@context": "https://schema.org", "@type": "Article", "headline": {JSON.stringify(post.data.title)}, "description": {JSON.stringify(post.data.description)}, "image": { "@type": "ImageObject", "url": `https://cloud-intelligence.github.io/webtest/logo.png`, "width": 1200, "height": 630 }, "author": { "@type": "Person", "name": {JSON.stringify(post.data.author)}, "url": "https://cloud-intelligence.github.io/webtest/team" }, "publisher": { "@type": "Organization", "@name": "Cloud Intelligence", "logo": { "@type": "ImageObject", "url": "https://cloud-intelligence.github.io/webtest/logo.png", "width": 200, "height": 200 }, "url": "https://cloud-intelligence.github.io/webtest/" }, "datePublished": {JSON.stringify(post.data.pubDate.toISOString())}, "dateModified": {JSON.stringify(post.data.pubDate.toISOString())}, "mainEntityOfPage": { "@type": "WebPage", "@id": `https://cloud-intelligence.github.io/webtest/blog/${post.slug}` }, "url": `https://cloud-intelligence.github.io/webtest/blog/${post.slug}`, "isPartOf": { "@type": "Blog", "name": "Cloud Intelligence Technical Blog", "url": "https://cloud-intelligence.github.io/webtest/resources/technical-blog" }, "articleSection": "Technology", "keywords": {JSON.stringify(post.data.tags.join(', '))}, "wordCount": 1500, "timeRequired": "PT5M", "about": [ { "@type": "Thing", "name": "Cloud Computing" }, { "@type": "Thing", "name": "Software Development" }, { "@type": "Thing", "name": "Technology Solutions" } ], "mentions": [ { "@type": "Organization", "name": "Cloud Intelligence", "url": "https://cloud-intelligence.github.io/webtest/" } ], "inLanguage": "en-US", "copyrightHolder": { "@type": "Organization", "name": "Cloud Intelligence" }, "copyrightYear": 2024, "license": "https://creativecommons.org/licenses/by-nc-sa/4.0/", "potentialAction": { "@type": "ReadAction", "target": `https://cloud-intelligence.github.io/webtest/blog/${post.slug}` } }</script>